<!DOCTYPE html>
<html lang="en">
  <head>
    <title>GraphQL Client</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
      crossorigin="anonymous"
    />
  </head>

  <body>
    <div class="container">
      <nav
        class="navbar navbar-expand-lg bg-body-tertiary"
        aria-label="Thirteenth navbar example"
      >
        <div class="container-fluid">
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarsExample11"
            aria-controls="navbarsExample11"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>

          <div class="collapse navbar-collapse d-lg-flex" id="navbarsExample11">
            <a class="navbar-brand col-lg-3 me-0" href="#" id="fullName"
              >Centered nav</a
            >
            <ul class="navbar-nav col-lg-6 justify-content-lg-center">
              <li class="nav-item">
                <a
                  class="nav-link"
                  id="homeLink"
                  aria-current="page"
                  href="./main.html"
                  >Home</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" id="employeesLink" href="./employees.html"
                  >Employees</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" id="departmentLink" href="./department.html"
                  >Department</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" id="shiftsLink" href="./shifts.html"
                  >Shifts</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" id="usersLink" href="./users.html">Users</a>
              </li>
            </ul>
            <div class="d-lg-flex col-lg-3 justify-content-lg-end">
              <button class="btn btn-danger" id="logout">logout</button>
            </div>
          </div>
        </div>
      </nav>
    </div>

    <h1>edit employee</h1>

    <div class="container">
      <form id="editEmployeeForm">
        <div class="form-group">
          <label for="employeeName">Employee Name:</label>
          <input
            type="text"
            name="employeeName"
            class="form-control"
            id="employeeName"
            required
          />
        </div>

        <div class="form-group">
          <label for="department">Department:</label>
          <select class="form-control" id="selectDepartment"></select>
        </div>

        <button type="submit" class="btn btn-primary" id="submit">
          Update
        </button>
        <button type="button" class="btn btn-danger" id="cancel">Cancel</button>
      </form>
    </div>

    <!-- create form with select tag with all availabe shifts and a button that add shift to table of all eployee shifts -->

    <form id="addShiftForm">
      <div class="form-group">
        <label for="shift">Shift:</label>
        <select class="form-control" id="selectShift"></select>
      </div>

      <button type="submit" class="btn btn-primary" id="submit">
        Add Shift
      </button>
    </form>

    <!-- create a table for all employee shifts  -->

    <table class="table table-striped table-hover" id="shiftsTable">
      <thead>
        <tr>
          <th scope="col">date</th>
          <th scope="col">startingHour</th>
          <th scope="col">endingHour</th>
        </tr>
      </thead>
      <tbody id="shiftsTableBody"></tbody>
    </table>

    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
      crossorigin="anonymous"
    ></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script type="module">
      import { getUser, logout, checkAuthentication } from "../js/utils.js";

      const urlParams = new URLSearchParams(window.location.search);
      const employeeId = urlParams.get("id");
      const selecteDepartment = document.getElementById("selectDepartment");
      const logoutBtn = document.getElementById("logout");
      window.onload = checkAuthentication();
      logoutBtn.addEventListener("click", logout);

      document.addEventListener("DOMContentLoaded", function () {
        const logoutBtn = document.getElementById("logout");
        const employeeName = document.getElementById("employeeName");
        logoutBtn.addEventListener("click", logout);

        getUser();
        getEmployee();
        popolateShiftsTable();

        const editEmployeeForm = document.getElementById("editEmployeeForm");
        editEmployeeForm.addEventListener("submit", (e) => {
          e.preventDefault();
          updateEmployee();
        });

        const addShiftForm = document.getElementById("addShiftForm");
        addShiftForm.addEventListener("submit", (e) => {
          e.preventDefault();
          addShift();
        });
      });

      const addShift = async () => {
        const shiftId = document.getElementById("selectShift").value;
        try {
          const response = await axios.post("http://localhost:8000/graphql", {
            query: `
                    mutation addUserToShift($shiftId: String, $userId: String) {
                      addUserToShift(shiftId: $shiftId, userId: $userId) {
                        _id
                        date
                        startingHour
                        endingHour
                        userId {
                          _id
                          firstName
                        }
                      }
                    }
                  `,
            variables: {
              shiftId: shiftId,
              userId: employeeId,
            },
          });

          console.log(response);
          alert("shift added successfully");

          //TODO: FIX THIS
          popolateShiftsTable();
        } catch (error) {
          console.log(error);
        }
      };

      const popolateShiftsTable = async () => {
        try {
          const response = await axios.post("http://localhost:8000/graphql", {
            query: `query($id: String){
                          employeeShifts(id: $id){
                              _id
                              date
                              startingHour
                              endingHour
                          }
                      }
                    `,
            variables: {
              id: employeeId,
            },
          });

          const shifts = response.data.data.employeeShifts;
          const shiftsTableBody = document.getElementById("shiftsTableBody");
          shifts.forEach((shift) => {
            const tr = document.createElement("tr");
            const dateTd = document.createElement("td");
            const startingHourTd = document.createElement("td");
            const endingHourTd = document.createElement("td");
            dateTd.innerHTML = shift.date;
            startingHourTd.innerHTML = shift.startingHour;
            endingHourTd.innerHTML = shift.endingHour;
            tr.appendChild(dateTd);
            tr.appendChild(startingHourTd);
            tr.appendChild(endingHourTd);
            shiftsTableBody.appendChild(tr);
          });

          const responseShifts = await axios.post(
            "http://localhost:8000/graphql",
            {
              query: `
            {
               shifts{
                 _id
                 date
                 startingHour
                 endingHour
                }
             }
              `,
            }
          );
          const shiftsOptions = responseShifts.data.data.shifts;
          const selectShift = document.getElementById("selectShift");
          // loop throw shifts and add just the selected shift that dosent appear in shifts
          shiftsOptions.forEach((shift) => {
            let isExist = false;
            shifts.forEach((shiftEmployee) => {
              if (shift._id === shiftEmployee._id) {
                isExist = true;
              }
            });
            if (!isExist) {
              const option = document.createElement("option");
              option.value = shift._id;
              option.innerHTML = shift.date;
              selectShift.appendChild(option);
            }
          });
        } catch (error) {}
      };

      const updateEmployee = async () => {
        const employeeName = document.getElementById("employeeName").value;
        const departmentId = selecteDepartment.value;
        try {
          const response = await axios.post("http://localhost:8000/graphql", {
            query: `mutation($id: String,$employee: EmployeeInput ){
                            updateEmployee(id: $id, employee: $employee){
                                _id
                                firstName
                                departmentID{
                                      name
                                      _id
                                  }
                               }
                             }
                           `,
            variables: {
              id: employeeId,
              employee: {
                firstName: employeeName,
                departmentID: departmentId,
              },
            },
          });
          alert("employee updated successfully");
          window.location.replace("./employees.html");
        } catch (error) {
          console.log(error);
        }
      };

      const getEmployee = async () => {
        try {
          const response = await axios.post("http://localhost:8000/graphql", {
            query: `query($id: String ){
                         employee(id: $id){
                          _id
                          firstName
                          departmentID{
                             _id
                              name
                            }
                         }
                      }
                       `,
            variables: {
              id: employeeId,
            },
          });

          //alert the user that the employee was created and go back to the employees page
          const employee = response.data.data.employee;
          //fill the form with the employee data
          employeeName.value = employee.firstName;
          const option = document.createElement("option");
          if (employee.departmentID === null) {
            option.value = "";
            option.innerHTML = "no department";
          } else {
            option.value = employee.departmentID._id;
            option.innerHTML = employee.departmentID.name;
          }
          selecteDepartment.appendChild(option);

          const responseDepartments = await axios.post(
            "http://localhost:8000/graphql",
            {
              query: `
            {
               departments{
                 _id
                 name
                }
             }
              `,
            }
          );
          const departments = responseDepartments.data.data.departments;
          //fill the select tag with all departments except the employee department
          departments.forEach((department) => {
            if (employee.departmentID === null) {
              const option = document.createElement("option");
              option.value = department._id;
              option.innerHTML = department.name;
              selecteDepartment.appendChild(option);
            } else if (department._id !== employee.departmentID._id) {
              const option = document.createElement("option");
              option.value = department._id;
              option.innerHTML = department.name;
              selecteDepartment.appendChild(option);
            }
          });
        } catch (error) {
          console.log(error);
        }
      };
    </script>
  </body>
</html>
